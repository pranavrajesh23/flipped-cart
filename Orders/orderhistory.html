<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
/>
<title>FlippedCart - Order History</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f9f9f9;
  }
  h2 { text-align: center; margin-bottom: 10px; }
   .filter-bar
   {
  position: fixed;
  margin-top: 78px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 30px;
  align-items: center;
  padding: 15px 10px;
  background-color: #ff9f00;
  color: white;
  z-index: 1000;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
   }
  .filter-btn {
    padding: 8px 16px;
    margin: 0 5px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    background: #eee;
    font-weight: bold;
  }
  .filter-btn.active {
    background: #ff6f61;
    color: #fff;
  }
  .status-group {
    margin-bottom: 30px;
  }
  .status-group h3 {
    color: #333;
    margin-bottom: 10px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 5px;
  }
  .order {
    background: #fff;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.1);
  }
  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .order-items {
    margin-top: 10px;
  }
  .item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    padding: 8px 0;
  }
  .item img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 5px;
    margin-right: 15px;
  }
  .item-info {
    display: flex;
    align-items: center;
    flex: 1;
    font-size: 14px;
  }
  .total {
    font-weight: bold;
    margin-top: 10px;
    text-align: right;
  }
  header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 15px 10px;
  background-color: #2874f0;
  color: white;
  z-index: 1000;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}
#logo{
    display: flex;
    gap: 10px;
    padding-right: 90px;
}
img{
    width: 50px; 
    height:50px;
    object-fit: cover; 
    border-radius: 30px; 
    padding-top: 5px;
}
  header h1 {
    font-size: 24px;
    font-weight: bold;
    padding-bottom: 10px;
  }
  
  .nav-links {
    display: flex;
    align-items: center;
    gap: 25px;
  }

  .nav-links a {
    color: white;
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
  }

  
  .nav-links a:hover {
  transform: scale(1.05);
}
.top-icons {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 35px;
  /* background: #fff; */
  padding: 15px;
  border-radius: 12px;
  /* box-shadow: 0 2px 8px rgba(0,0,0,0.1); */
}

.icon-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-family: Arial, sans-serif;
}

.icon-item i {
  font-size: 25px;              /* bigger icons */
  color: #ffffff;               /* default color */
  transition: transform 0.2s, color 0.2s;
}

.icon-item span {
  font-size: 13px;
  color: #ffffff;
  margin-top: 5px;
  font-weight: 500;
}

/* Hover effects */
.icon-item:hover i {
  color: #ff9f00;
  transform: scale(1.2);
}
#enter{
    margin-top: 160px;
}
</style>
</head>
<body>

  <header>
    <div id="logo">
    <img src="../bg.png" alt="logo" onclick="window.location.href='../User/user.html'"/>
    <h1 onclick="window.location.href='../User/user.html'">FlippedCart</h1>
    </div>
    <h2 id="orderpage"></h2>
    <div class="nav-links">
      <div class="top-icons">
        <div class="icon-item">
        <a id="wishlistLink"><i class="fa fa-heart" aria-hidden="true"></i></a>
        <span>Wishlist</span>
      </div>

      <div class="icon-item">
        <a id="cartLink"><i class="fa fa-shopping-cart" aria-hidden="true"></i></a>
        <span>Cart</span>
      </div>

      <div class="icon-item">
        <a id="ordersLink"><i class="fa fa-archive" aria-hidden="true"></i></a>
        <span>Orders</span>
      </div>

      <div class="icon-item">
        <a id="profileLink"><i class="fa fa-user-circle" aria-hidden="true"></i></a>
        <span>Profile</span>
      </div>

      <div class="icon-item">
        <a id="logoutBtn"><i class="fa fa-sign-out" aria-hidden="true"></i></a>
        <span>Logout</span>
      </div>
    </div>
  </div>
</header>

<div class="filter-bar">
  <button class="filter-btn active" data-status="All">All</button>
  <button class="filter-btn" data-status="Delivered">Delivered</button>
  <button class="filter-btn" data-status="Cancelled">Cancelled</button>
  <button class="filter-btn" data-status="Returned">Returned</button>
</div>
<div id="enter"><div id="historyContainer"></div></div>


<script>
const projectId = "flippedcart8751";
const historyContainer = document.getElementById("historyContainer");
const userEmail = sessionStorage.getItem("googleEmail");
document.getElementById('logoutBtn').addEventListener('click', () => {
  sessionStorage.clear();
  window.location.href = "../index.html";
});
document.getElementById('wishlistLink').addEventListener('click', () => {
  window.location.href = "../Wishlist/wishlist.html";
});
document.getElementById('cartLink').addEventListener('click', () => {
  window.location.href = "../Cart/cart.html";
});
document.getElementById('ordersLink').addEventListener('click', () => {
  window.location.href = "../Orders/orders.html";
});
document.getElementById('profileLink').addEventListener('click', () => {
  window.location.href = "../Profile/profile.html";
});
let localPart = userEmail.split('@')[0];
// Remove the number and anything after it (like 2021eee)
let namePart = localPart.split(/[0-9]/)[0];
console.log(namePart);
// Capitalize the first letter
namePart = namePart.toUpperCase()
document.getElementById('orderpage').textContent = `HI ${namePart}, YOU'RE ORDER HISTORY`;
let allOrders = [];

// Fetch order history
async function fetchOrderHistory() {
  const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents:runQuery`;
  const body = {
    structuredQuery: {
      from: [{ collectionId: "OrderHistory" }],
      where: {
        fieldFilter: {
          field: { fieldPath: "userId" },
          op: "EQUAL",
          value: { stringValue: userEmail }
        }
      }
    }
  };

  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const data = await res.json();
  allOrders = data
    .map(d => d.document)
    .filter(d => d)
    .map(d => ({
      id: d.name.split("/").pop(),
      orderId: d.fields.orderId.stringValue,
      title: d.fields.title.stringValue,
      price: d.fields.price.doubleValue,
      quantity: d.fields.quantity.integerValue,
      imgUrl: d.fields.imgUrl.stringValue,
      orderDate: d.fields.orderDate.stringValue,
      deliveryDate: d.fields.deliveryDate.stringValue,
      status: d.fields.status.stringValue
    }));
    console.log(allOrders);
  displayOrderHistory(allOrders);
}

// Display orders (optionally filtered)
function displayOrderHistory(orders, filterStatus = "All") {
  const filteredOrders = filterStatus === "All" ? orders : orders.filter(o => o.status === filterStatus);

  // Group orders by status
  const groupedByStatus = {};
  filteredOrders.forEach(order => {
    if (!groupedByStatus[order.status]) groupedByStatus[order.status] = [];
    groupedByStatus[order.status].push(order);
  });

  historyContainer.innerHTML = "";

  for (const status in groupedByStatus) {
    const groupDiv = document.createElement("div");
    groupDiv.className = "status-group";

    const heading = document.createElement("h3");
    heading.textContent = status;
    groupDiv.appendChild(heading);

    const ordersByStatus = groupedByStatus[status];

    // Group items by orderId
    const groupedOrders = {};
    ordersByStatus.forEach(item => {
      if (!groupedOrders[item.orderId]) groupedOrders[item.orderId] = [];
      groupedOrders[item.orderId].push(item);
    });

    for (const orderId in groupedOrders) {
      const orderItems = groupedOrders[orderId];
      const orderDiv = document.createElement("div");
      orderDiv.className = "order";
      const od = new Date(orderItems[0].orderDate).toDateString();
      const header = document.createElement("div");
      header.className = "order-header";
      header.innerHTML = `
        <div><strong>Order ID:</strong> ${orderId}</div>
        <div>Order Date: ${new Date(orderItems[0].orderDate).toDateString()}</div>
        <div>Delivery Date: ${orderItems[0].deliveryDate}</div>
      `;
      orderDiv.appendChild(header);

      const itemsDiv = document.createElement("div");
      itemsDiv.className = "order-items";

      let total = 0;
      orderItems.forEach(item => {
        total += item.price * item.quantity;

        const itemDiv = document.createElement("div");
        itemDiv.className = "item";
        itemDiv.innerHTML = `
          <div class="item-info">
            <img src="${item.imgUrl}" alt="${item.title}" />
            <span>${item.title} x${item.quantity}</span>
          </div>
          <span>₹${item.price * item.quantity}</span>
        `;
        itemsDiv.appendChild(itemDiv);
      });

      const totalDiv = document.createElement("div");
      totalDiv.className = "total";
      totalDiv.textContent = `Total: ₹${total}`;

      orderDiv.appendChild(itemsDiv);
      orderDiv.appendChild(totalDiv);
      groupDiv.appendChild(orderDiv);
    }

    historyContainer.appendChild(groupDiv);
  }
}

// Filter buttons
document.querySelectorAll(".filter-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    displayOrderHistory(allOrders, btn.dataset.status);
  });
});

fetchOrderHistory();
</script>

</body>
</html>
