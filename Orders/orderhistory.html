<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlippedCart - Order History</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f9f9f9;
  }
  h2 { text-align: center; margin-bottom: 10px; }
  .filter-bar {
    text-align: center;
    margin-bottom: 20px;
  }
  .filter-btn {
    padding: 8px 16px;
    margin: 0 5px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    background: #eee;
    font-weight: bold;
  }
  .filter-btn.active {
    background: #ff6f61;
    color: #fff;
  }
  .status-group {
    margin-bottom: 30px;
  }
  .status-group h3 {
    color: #333;
    margin-bottom: 10px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 5px;
  }
  .order {
    background: #fff;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.1);
  }
  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .order-items {
    margin-top: 10px;
  }
  .item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    padding: 8px 0;
  }
  .item img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 5px;
    margin-right: 15px;
  }
  .item-info {
    display: flex;
    align-items: center;
    flex: 1;
    font-size: 14px;
  }
  .total {
    font-weight: bold;
    margin-top: 10px;
    text-align: right;
  }
</style>
</head>
<body>

<h2>Your Order History</h2>

<div class="filter-bar">
  <button class="filter-btn active" data-status="All">All</button>
  <button class="filter-btn" data-status="Delivered">Delivered</button>
  <button class="filter-btn" data-status="Cancelled">Cancelled</button>
  <button class="filter-btn" data-status="Returned">Returned</button>
</div>

<div id="historyContainer"></div>

<script>
const projectId = "flippedcart8751";
const historyContainer = document.getElementById("historyContainer");
const userEmail = sessionStorage.getItem("googleEmail");
let allOrders = [];

// Fetch order history
async function fetchOrderHistory() {
  const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents:runQuery`;
  const body = {
    structuredQuery: {
      from: [{ collectionId: "OrderHistory" }],
      where: {
        fieldFilter: {
          field: { fieldPath: "userId" },
          op: "EQUAL",
          value: { stringValue: userEmail }
        }
      }
    }
  };

  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const data = await res.json();
  allOrders = data
    .map(d => d.document)
    .filter(d => d)
    .map(d => ({
      id: d.name.split("/").pop(),
      orderId: d.fields.orderId.stringValue,
      title: d.fields.title.stringValue,
      price: d.fields.price.doubleValue,
      quantity: d.fields.quantity.integerValue,
      imgUrl: d.fields.imgUrl.stringValue,
      orderDate: d.fields.orderDate.stringValue,
      deliveryDate: d.fields.deliveryDate.stringValue,
      status: d.fields.status.stringValue
    }));
    console.log(allOrders);
  displayOrderHistory(allOrders);
}

// Display orders (optionally filtered)
function displayOrderHistory(orders, filterStatus = "All") {
  const filteredOrders = filterStatus === "All" ? orders : orders.filter(o => o.status === filterStatus);

  // Group orders by status
  const groupedByStatus = {};
  filteredOrders.forEach(order => {
    if (!groupedByStatus[order.status]) groupedByStatus[order.status] = [];
    groupedByStatus[order.status].push(order);
  });

  historyContainer.innerHTML = "";

  for (const status in groupedByStatus) {
    const groupDiv = document.createElement("div");
    groupDiv.className = "status-group";

    const heading = document.createElement("h3");
    heading.textContent = status;
    groupDiv.appendChild(heading);

    const ordersByStatus = groupedByStatus[status];

    // Group items by orderId
    const groupedOrders = {};
    ordersByStatus.forEach(item => {
      if (!groupedOrders[item.orderId]) groupedOrders[item.orderId] = [];
      groupedOrders[item.orderId].push(item);
    });

    for (const orderId in groupedOrders) {
      const orderItems = groupedOrders[orderId];
      const orderDiv = document.createElement("div");
      orderDiv.className = "order";
      const od = new Date(orderItems[0].orderDate).toDateString();
      const header = document.createElement("div");
      header.className = "order-header";
      header.innerHTML = `
        <div><strong>Order ID:</strong> ${orderId}</div>
        <div>Order Date: ${new Date(orderItems[0].orderDate).toDateString()}</div>
        <div>Delivery Date: ${orderItems[0].deliveryDate}</div>
      `;
      orderDiv.appendChild(header);

      const itemsDiv = document.createElement("div");
      itemsDiv.className = "order-items";

      let total = 0;
      orderItems.forEach(item => {
        total += item.price * item.quantity;

        const itemDiv = document.createElement("div");
        itemDiv.className = "item";
        itemDiv.innerHTML = `
          <div class="item-info">
            <img src="${item.imgUrl}" alt="${item.title}" />
            <span>${item.title} x${item.quantity}</span>
          </div>
          <span>₹${item.price * item.quantity}</span>
        `;
        itemsDiv.appendChild(itemDiv);
      });

      const totalDiv = document.createElement("div");
      totalDiv.className = "total";
      totalDiv.textContent = `Total: ₹${total}`;

      orderDiv.appendChild(itemsDiv);
      orderDiv.appendChild(totalDiv);
      groupDiv.appendChild(orderDiv);
    }

    historyContainer.appendChild(groupDiv);
  }
}

// Filter buttons
document.querySelectorAll(".filter-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    displayOrderHistory(allOrders, btn.dataset.status);
  });
});

fetchOrderHistory();
</script>

</body>
</html>
