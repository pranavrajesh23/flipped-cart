<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="admin.css">
<title>FlippedCart - Admin Dashboard</title>
<style>
  /* Temporary inline style for layout tweak */
  #adminEmail { position: absolute; top: 10px; right: 20px; font-weight: bold; }
  #navMenu { text-align: center; margin: 80px 0 20px 0; }
  .section { margin: 20px; }
  #messageContainer { text-align: center; border-radius: 5px; }
  .card { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
  .card img { max-width: 100px; display: block; }
  .action-buttons { margin-top: 10px; }
</style>
</head>
<body>
<div class="container">
  <h1>üõçÔ∏è FlippedCart Admin Panel</h1>
  <h3 id="adminEmail"></h3>

  <div id="navMenu">
    <button onclick="showSection('profile')">Profile</button>
    <button onclick="showSection('product')">Product CRUD</button>
    <button onclick="showSection('user')">User CRUD</button>
  </div>

  <div id="messageContainer" style="display:none;"></div>

  <div id="profileSection" class="section">
    <h2>Profile</h2>
    <p>Email: <span id="profileEmail"></span></p>
  </div>

  <div id="productSection" class="section" style="display:none;">
    <h2>Product CRUD</h2>
    <form id="productForm">
      <input type="hidden" id="productId">
      <input type="text" id="name" placeholder="Product Name" required>
      <input type="text" id="imgurl" placeholder="Image URL" required>
      <input type="text" id="description" placeholder="Description" required>
      <input type="number" id="quantity" placeholder="Quantity" required>
      <input type="number" id="price" placeholder="Price" required>
      <input type="text" id="category" placeholder="Category" required>
      <button type="submit">Add / Update Product</button>
    </form>
    <div id="productContainer"></div>
  </div>

  <div id="userSection" class="section" style="display:none;">
    <h2>User CRUD</h2>
    <form id="userForm">
      <input type="hidden" id="userId">
      <input type="text" id="name" placeholder="Name" required>
      <input type="email" id="email" placeholder="Email" required>
      <input type="text" id="role" placeholder="Role" required>
      <button type="submit">Add / Update User</button>
    </form>
    <div id="userContainer"></div>
  </div>
</div>

<script>
const projectId = "flippedcart8751";
const apiKey = "AIzaSyAR10NJqR8wUDIimsxHMsW307P_vdbO_dE";
let adminEmail = null;

const messageContainer = document.getElementById('messageContainer');
function showMessage(msg, type='info') {
  messageContainer.innerText = msg;
  messageContainer.style.display = 'block';
  messageContainer.style.color = type === 'error' ? 'red' : 'green';
  setTimeout(() => { messageContainer.style.display = 'none'; }, 3000);
}

// Verify admin
async function verifyAdmin() {
  const email = sessionStorage.getItem("googleEmail");
  if (!email) { window.location.href = "index.html"; return; }
  adminEmail = email;
  document.getElementById("adminEmail").innerText = adminEmail;
  document.getElementById("profileEmail").innerText = adminEmail;

  const docId = email.replace(/[@.]/g, '_');
  const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/admin/${docId}?key=${apiKey}`;
  const res = await fetch(url);
  if (!res.ok) { window.location.href = "index.html"; } 
  else { loadProducts(); loadUsers(); }
}

// Load products
async function loadProducts() {
  const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/products?key=${apiKey}`;
  const res = await fetch(url);
  const data = await res.json();
  const container = document.getElementById("productContainer");
  container.innerHTML = "";
  if (!data.documents) return;

  data.documents.forEach(doc => {
    const f = doc.fields;
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <img src="${f.imgurl.stringValue}" alt="">
      <div class="card-content">
        <h3>${f.name.stringValue}</h3>
        <p>${f.description.stringValue}</p>
        <p class="price">‚Çπ${f.price.stringValue}</p>
        <p class="stock">Stock: ${f.quantity.stringValue}</p>
        <p class="category">Category: ${f.category.stringValue}</p>
      </div>
      <div class="action-buttons">
        <button class="edit-btn" onclick="editProduct('${doc.name.split('/').pop()}')">‚úèÔ∏è Edit</button>
        <button class="delete-btn" onclick="deleteProduct('${doc.name.split('/').pop()}')">üóëÔ∏è Delete</button>
      </div>
    `;
    container.appendChild(card);
  });
}

// Load users
async function loadUsers() {
  const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/users?key=${apiKey}`;
  const res = await fetch(url);
  const data = await res.json();
  const container = document.getElementById("userContainer");
  container.innerHTML = "";
  if (!data.documents) return;

  data.documents.forEach(doc => {
    const f = doc.fields;
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <h3>${f.name.stringValue}</h3>
      <p>Email: ${f.email.stringValue}</p>
      <p>Role: ${f.role.stringValue}</p>
      <div class="action-buttons">
        <button class="edit-btn" onclick="editUser('${doc.name.split('/').pop()}')">‚úèÔ∏è Edit</button>
        <button class="delete-btn" onclick="deleteUser('${doc.name.split('/').pop()}')">üóëÔ∏è Delete</button>
      </div>
    `;
    container.appendChild(card);
  });
}

// Show section
function showSection(section) {
  document.querySelectorAll('.section').forEach(sec => { sec.style.display = 'none'; });
  document.getElementById(section + 'Section').style.display = 'block';
}

// Edit product
async function editProduct(docId) {
  const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/products/${docId}?key=${apiKey}`;
  const res = await fetch(url);
  const data = await res.json();
  const f = data.fields;
  document.getElementById("productId").value = f.productId.stringValue;
  document.getElementById("name").value = f.name.stringValue;
  document.getElementById("imgurl").value = f.imgurl.stringValue;
  document.getElementById("description").value = f.description.stringValue;
  document.getElementById("quantity").value = f.quantity.stringValue;
  document.getElementById("price").value = f.price.stringValue;
  document.getElementById("category").value = f.category.stringValue;
  showMessage("Editing product");
}

// Delete product
async function deleteProduct(docId) {
  const div = document.createElement('div');
  div.innerHTML = `Delete this product? <button id="yes">Yes</button> <button id="no">No</button>`;
  messageContainer.innerHTML = '';
  messageContainer.appendChild(div);
  messageContainer.style.display = 'block';
  document.getElementById('yes').onclick = async () => {
    await fetch(`https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/products/${docId}?key=${apiKey}`, { method:'DELETE' });
    messageContainer.style.display = 'none';
    loadProducts();
    showMessage("Product deleted");
  };
  document.getElementById('no').onclick = () => { messageContainer.style.display = 'none'; };
}

// Edit user
async function editUser(docId) {
  const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/users/${docId}?key=${apiKey}`;
  const res = await fetch(url);
  const data = await res.json();
  const f = data.fields;
  document.getElementById("userId").value = f.userId.stringValue;
  document.getElementById("name").value = f.name.stringValue;
  document.getElementById("email").value = f.email.stringValue;
  document.getElementById("role").value = f.role.stringValue;
  showMessage("Editing user");
}

// Delete user
async function deleteUser(docId) {
  const div = document.createElement('div');
  div.innerHTML = `Delete this user? <button id="yes">Yes</button> <button id="no">No</button>`;
  messageContainer.innerHTML = '';
  messageContainer.appendChild(div);
  messageContainer.style.display = 'block';
  document.getElementById('yes').onclick = async () => {
    await fetch(`https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/users/${docId}?key=${apiKey}`, { method:'DELETE' });
    messageContainer.style.display = 'none';
    loadUsers();
    showMessage("User deleted");
  };
  document.getElementById('no').onclick = () => { messageContainer.style.display = 'none'; };
}

// Form submit handling
document.getElementById('productForm').onsubmit = async (e) => {
  e.preventDefault();
  const productId = document.getElementById('productId').value || Date.now().toString();
  const name = document.getElementById('name').value;
  const imgurl = document.getElementById('imgurl').value;
  const description = document.getElementById('description').value;
  const quantity = document.getElementById('quantity').value;
  const price = document.getElementById('price').value;
  const category = document.getElementById('category').value;

  const docData = {
    fields: {
      productId: { stringValue: productId },
      name: { stringValue: name },
      imgurl: { stringValue: imgurl },
      description: { stringValue: description },
      quantity: { stringValue: quantity },
      price: { stringValue: price },
      category: { stringValue: category }
    }
  };

  await fetch(`https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/products/${productId}?key=${apiKey}`, {
    method:'PATCH',
    body: JSON.stringify(docData)
  });
  showMessage("Product added/updated");
  loadProducts();
  e.target.reset();
};

document.getElementById('userForm').onsubmit = async (e) => {
  e.preventDefault();
  const userId = document.getElementById('userId').value || Date.now().toString();
  const name = document.getElementById('name').value;
  const email = document.getElementById('email').value;
  const role = document.getElementById('role').value;

  const docData = {
    fields: {
      userId: { stringValue: userId },
      name: { stringValue: name },
      email: { stringValue: email },
      role: { stringValue: role }
    }
  };

  await fetch(`https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/users/${userId}?key=${apiKey}`, {
    method:'PATCH',
    body: JSON.stringify(docData)
  });
  showMessage("User added/updated");
  loadUsers();
  e.target.reset();
};

verifyAdmin();
</script>
</body>
</html>
