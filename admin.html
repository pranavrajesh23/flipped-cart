<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlippedCart - Admin Dashboard</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f7f8fc;
  padding: 20px;
}
.container {
  max-width: 1000px;
  margin: auto;
  background: white;
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
h1 {
  text-align: center;
  color: #333;
}
form {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}
input, select {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  flex: 1;
  min-width: 150px;
}
button {
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  background: #4285F4;
  color: white;
  cursor: pointer;
}
button:hover {
  opacity: 0.9;
}
#productContainer {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 15px;
}
.card {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  overflow: hidden;
  text-align: center;
  transition: 0.2s;
}
.card:hover {
  transform: scale(1.02);
}
.card img {
  width: 100%;
  height: 160px;
  /* object-fit: cover; */
  object-fit: contain;
  background: #f0f0f0;
}
.card-content {
  padding: 10px;
}
.card h3 {
  margin: 5px 0;
  color: #333;
}
.card p {
  font-size: 14px;
  color: #555;
}
.card .price {
  color: green;
  font-weight: bold;
}
.card .stock {
  color: #777;
  font-size: 13px;
}
.card .category {
  font-size: 12px;
  color: #999;
}
.action-buttons {
  display: flex;
  justify-content: center;
  gap: 10px;
  padding: 10px;
}
.action-buttons button {
  border: none;
  border-radius: 5px;
  padding: 6px 10px;
  cursor: pointer;
}
.edit-btn {
  background-color: #ffb300;
  color: #fff;
}
.delete-btn {
  background-color: #d9534f;
  color: #fff;
}
</style>
</head>
<body>

<div class="container">
  <h1>üõçÔ∏è FlippedCart Admin Panel</h1>
  <h3 id="adminEmail"></h3>

  <form id="productForm">
    <input type="hidden" id="productId">
    <!-- <input type="text" id="productId" placeholder="Product ID" required> -->
    <input type="text" id="name" placeholder="Product Name" required>
    <input type="text" id="imgurl" placeholder="Image URL" required>
    <input type="text" id="description" placeholder="Description" required>
    <input type="number" id="quantity" placeholder="Quantity" required>
    <input type="number" id="price" placeholder="Price" required>
    <select id="category" required>
      <option value="">Category</option>
      <option>Electronics</option>
      <option>Fashion</option>
      <option>Home</option>
      <option>Grocery</option>
      <option>Sports</option>
    </select>
    <button type="submit">Add / Update</button>
  </form>

  <!-- üîπ Product Display Section -->
  <div id="productContainer"></div>
</div>

<script>
// üîπ Firebase Config
const projectId = "flippedcart8751"; // your firebase project id
const apiKey = "AIzaSyAR10NJqR8wUDIimsxHMsW307P_vdbO_dE"; // your firebase web api key

let adminEmail = null;

// ‚úÖ Check if user is valid admin before allowing CRUD
async function verifyAdmin(){
    const email = sessionStorage.getItem("googleEmail");
    if(!email){
        alert("Unauthorized access!");
        window.location.href="index.html";
        return;
    }
    adminEmail = email;
    document.getElementById("adminEmail").innerText = "Logged in as: " + adminEmail;

    const docId = email.replace(/[@.]/g,'_');
    const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/admin/${docId}?key=${apiKey}`;
    const res = await fetch(url);
    if(!res.ok){
        alert("You are not an admin!");
        window.location.href="index.html";
    } else {
        loadProducts();
    }
}

// üîπ Load Products (Card View)
async function loadProducts(){
    const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/products?key=${apiKey}`;
    const res = await fetch(url);
    const data = await res.json();
    const container = document.getElementById("productContainer");
    container.innerHTML = "";

    if(!data.documents) return;

    data.documents.forEach(doc => {
        const f = doc.fields;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="${f.imgurl.stringValue}" alt="">
          <div class="card-content">
            <h3>${f.name.stringValue}</h3>
            <p>${f.description.stringValue}</p>
            <p class="price">‚Çπ${f.price.stringValue}</p>
            <p class="stock">Stock: ${f.quantity.stringValue}</p>
            <p class="category">Category: ${f.category.stringValue}</p>
          </div>
          <div class="action-buttons">
            <button class="edit-btn" onclick="editProduct('${doc.name.split('/').pop()}')">‚úèÔ∏è Edit</button>
            <button class="delete-btn" onclick="deleteProduct('${doc.name.split('/').pop()}')">üóëÔ∏è Delete</button>
          </div>
        `;
        container.appendChild(card);
    });
}

async function getNextProductId() {
    const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/products?key=${apiKey}`;
    const res = await fetch(url);
    const data = await res.json();
    const count = data.documents ? data.documents.length : 0;
    return `P${(count + 1).toString().padStart(3, '0')}`;
}


// üîπ Add / Update Product
document.getElementById("productForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    // Generate ID only when adding a new product
    let productId = document.getElementById("productId").value.trim();
    if (!productId) {
        productId = await getNextProductId();
    }

    const product = {
        productId: productId,
        name: document.getElementById("name").value,
        imgurl: document.getElementById("imgurl").value,
        description: document.getElementById("description").value,
        quantity: document.getElementById("quantity").value,
        price: document.getElementById("price").value,
        category: document.getElementById("category").value
    };

    const docId = productId.replace(/[@.]/g, '_');
    const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/products/${docId}?key=${apiKey}`;

    const body = {
        fields: Object.fromEntries(Object.entries(product).map(([k, v]) => [k, { stringValue: v }]))
    };

    await fetch(url, { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
    alert("‚úÖ Product added/updated successfully!");
    e.target.reset();
    loadProducts();
});


// üîπ Edit Product
async function editProduct(docId){
    const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/products/${docId}?key=${apiKey}`;
    const res = await fetch(url);
    const data = await res.json();
    const f = data.fields;
    document.getElementById("productId").value = f.productId.stringValue;
    document.getElementById("name").value = f.name.stringValue;
    document.getElementById("imgurl").value = f.imgurl.stringValue;
    document.getElementById("description").value = f.description.stringValue;
    document.getElementById("quantity").value = f.quantity.stringValue;
    document.getElementById("price").value = f.price.stringValue;
    document.getElementById("category").value = f.category.stringValue;
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// üîπ Delete Product
async function deleteProduct(docId){
    if(!confirm("Delete this product?")) return;
    const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/products/${docId}?key=${apiKey}`;
    await fetch(url, { method:"DELETE" });
    alert("Product deleted!");
    loadProducts();
}

// Initialize
verifyAdmin();
</script>

</body>
</html>
